<html>
<!-- style -->

<link href="http://docs.neo4j.org/chunked/snapshot/css/shCore.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/shCoreEclipse.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/shThemeEclipse.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/neo.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/neo-asciidoc.css" rel="stylesheet" type="text/css"/>

<!-- Syntax Highlighter -->

<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shCore.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushJava.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushJScript.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushBash.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushPlain.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushXml.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushGroovy.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushCypher.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushScala.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushSql.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushPython.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushProperties.js"></script>
<script src="/assets/js/opal.js"></script>
<script src="/assets/js/asciidoctor.js"></script>
<script src="/assets/js/jquery-1.8.1.min.js"></script>
<script src="http://docs.neo4j.org/chunked/snapshot/js/cypherconsole.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>

<style>
    .node {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    .link {
        stroke: #999;
        stroke-opacity: .6;
    }

    .graph {
        border-style: solid;
        border-width: 1px;
    }
</style>

<script type="text/javascript">
    function executeQueries() {
        $("code.cypher").each(function (index, element) {
            var statement = $(element).text();
            console.log("executing", statement);
            execute(statement, function (results) {
                var graphEl = ".graph" + (index + 1);
                $(graphEl).each(function (i, el) {
                    var viz = JSON.parse(results)['visualization'];
//                    console.log("applying to", results, viz, el);
                    var svg = d3.select(el).append("svg");
                    d3graph(viz, svg);
                });
            });
        });
    }

    function execute(statement, callback) {
        $.ajax({
            type: "POST",
            url: "http://rabbithole-test.herokuapp.com//console/cypher",
            data: statement,
            success: function (data) {
//                console.log(data);
                callback(data);
            }
        });
    }

    function sanitizeContents(content) {
        content = content.replace("\n// console\n", "++++\n<p class=\"cypherdoc-console\"\"><iframe id=\"cypherdoc-console\" class=\"cypherdoc-console\" src=\"http://console-test.neo4j.org\"></iframe></p>\n++++");
        return content.
                replace(/^\/\/\W*graph(.*)/gm, function (match, name) {
                    return "++++\n<div>Graph after <a href=\"#query"+name+"\">Query " + name + "</a></div><div class=\"graph graph" + name + "\"></div>\n++++\n";
                });
    }


    $(document).ready(function () {
                var url = "https://api.github.com/gists/<%= gist %>";
                $.ajax({
                    url: url,
                    success: function (data) {
                        var file = data.files[Object.keys(data.files)[0]];
                        var content = file.content;
//                        console.log(data);
                        $("#gist_link").attr("href", data.html_url);
                        content = sanitizeContents(content);
//                        console.log(content);
                        document.getElementById('content').innerHTML = Opal.Asciidoctor.$render(content);
                        executeQueries();
//                        $("#console").
                        $("pre>code").each(function (index, el) {
                            var number = (index + 1);
                            console.log("cypher ", arguments);
                            $(el).attr("class", "brush: cypher");
                            $(el).parent().prepend("<a name=\"query" + number + "\">Query " + number + "</a><br/>");
                        });
                        SyntaxHighlighter.config.tagName = 'code';
                        SyntaxHighlighter.all()
                    },
                    dataType: "json"
                });
            }
    );
    function d3graph(graph, svg) {
        var width = 200, height = 200;
        svg.attr("width", width)
                .attr("height", height)
        var color = d3.scale.category20();

        var force = d3.layout.force()
                .charge(-120)
                .linkDistance(30)
                .size([width, height]);
        force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();

        var link = svg.selectAll(".link")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link")
                .style("stroke-width", function (d) {
                    return Math.sqrt(d.value);
                });

        var node = svg.selectAll(".node")
                .data(graph.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 5)
                .style("fill", function (d) {
                    return color(d.group);
                })
                .call(force.drag);

        node.append("title")
                .text(function (d) {
                    return d.name;
                });

        force.on("tick", function () {
            link.attr("x1", function (d) {
                return d.source.x;
            })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });

            node.attr("cx", function (d) {
                return d.x;
            })
                    .attr("cy", function (d) {
                        return d.y;
                    });
        });
    }

</script>
<body>
<a href="https://github.com/neo4j-contrib/graphgist"><img style="position: absolute; top: 0; right: 0; border: 0;"
                                                          src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
                                                          alt="Fork me on GitHub"></a>


<h2>Graph Gist for <a id="gist_link" href="" target="_blank">Gist #<%= gist %></a></h2>

<div id="content"></div>
</body>
</html>