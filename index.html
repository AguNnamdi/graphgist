<html>
<!-- style -->

<link href="http://docs.neo4j.org/chunked/snapshot/css/shCore.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/shCoreEclipse.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/shThemeEclipse.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/neo.css" rel="stylesheet" type="text/css"/>
<link href="http://docs.neo4j.org/chunked/snapshot/css/neo-asciidoc.css" rel="stylesheet" type="text/css"/>

<script src="js/opal.js"></script>
<script src="js/asciidoctor.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="js/jquery.ba-hashchange.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<!--bootstrap-->
<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<!-- Syntax Highlighter -->

<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shCore.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushJScript.js"></script>
<script type="text/javascript" src="http://docs.neo4j.org/chunked/snapshot/js/shBrushCypher.js"></script>

<script src="js/cypherconsole.js"></script>

<style>
    .node {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    .link {
        stroke: #999;
        stroke-opacity: .6;
    }

    .graph {
        border-style: solid;
        border-width: 1px;
    }

    html {
        background: none;
    }

    html body {
        background: none;
    }

</style>

<script type="text/javascript">
    
    $(window).hashchange(function(){
        $('#content').empty();
        renderPage();
    });
    function executeQueries() {
        $("code.cypher").each(function (index, element) {
            var statement = $(element).text();
            execute(statement, function (results) {
                var data = JSON.parse(results);
                var viz = data['visualization'];
                var newlines = results.replace(/\\n/g, '&#013;');
                if (data.error) {
                    $(element).append("<span class='label label-error' title='" + newlines + "'>ERROR<div class='tooltip'>Here some info</div></span >");

                } else {
                    $(element).append("<span class='label label-success' title='" + newlines + "'>OK<div class='tooltip'>Here some info</div></span >");
                    var graphEl = ".graph" + (index + 1);
                    $(graphEl).each(function (i, el) {
//                    console.log("applying to", results, viz, el);
                        var svg = d3.select(el).append("svg");
                        d3graph(viz, svg);

                    });
                }
            }, function (results) {
                console.log("execution error", arguments);
            });
        });
    }

    function execute(statement, callback, error) {
        $.ajax({
            type: "POST",
            url: "http://rabbithole-test.herokuapp.com//console/cypher",
            data: statement,
            success: callback,
            error: error
        });
    }

    function sanitizeContents(content) {
        content = content.replace("\n// console\n", "++++\n<p class=\"cypherdoc-console\"\"></p>\n++++");
        return content.
                replace(/^\/\/\W*graph(.*)/gm, function (match, name) {
                    return "++++\n<div>Graph after <a href=\"#query" + name + "\">Query " + name + "</a></div><div class=\"graph graph" + name + "\"></div>\n++++\n";
                });
    }


    function renderPage() {
        var gist = (window.location.hash || "#5857879").substr(1);
        var url = "https://api.github.com/gists/" + gist;
        $.ajax({
            url: url,
            success: function (data) {
                var file = data.files[Object.keys(data.files)[0]];
                var content = file.content;
                $("#gist_link").attr("href", data.html_url);
                content = sanitizeContents(content);
                document.getElementById('content').innerHTML = Opal.Asciidoctor.$render(content);
                executeQueries();
                $("pre>code").each(function (index, el) {
                    var number = (index + 1);
                    $(el).attr("class", "brush: cypher");
                    $(el).parent().prepend("<a name=\"query" + number + "\">Query " + number + "</a><br/>");
                });

                createCypherConsoles($);
                SyntaxHighlighter.config.tagName = 'code';
                SyntaxHighlighter.all();

            },
            dataType: "json"
        });
    }
    $(document).ready(function () {
                renderPage();
            }
    );
    function d3graph(graph, svg) {
        var width = 500, height = 200;
        svg.attr("width", width)
                .attr("height", height)
        var color = d3.scale.category20();

        var force = d3.layout.force()
                .charge(-120)
                .linkDistance(10)
                .size([width, height]);
        force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();

        var link = svg.selectAll(".link")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link")
                .style("stroke-width", function (d) {
                    return Math.sqrt(d.value);
                });

        var node = svg.selectAll(".node")
                .data(graph.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 5)
                .style("fill", function (d) {
                    return color(d.group);
                })
                .call(force.drag);

        node.append("title")
                .text(function (d) {
                    return d.name;
                });

        force.on("tick", function () {
            link.attr("x1", function (d) {
                return d.source.x;
            })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });

            node.attr("cx", function (d) {
                return d.x;
            })
                    .attr("cy", function (d) {
                        return d.y;
                    });
        });
    }

</script>
<body>

<div class="navbar  navbar-inverse">
    <div class="navbar-inner">
        <div class="container">
            <a class="brand" href="http://neo4j.org"> <img style="height: 50px"
                                                           src="http://assets.neo4j.org/new/img/logo-white.svg"></a>
        </div>
        <ul class="nav">
            <li>
                <a class="brand" href="http://graphgist.herokuapp.com">Neo4j GraphGists</a>
            </li>
        </ul>
    </div>
    <a class="btn" id="gist_link" href="" target="_blank">View/Fork/Clone this GraphGist.</a>
</div>
<div id="content">

</div>
<footer><a href="https://github.com/neo4j-contrib/graphgist">Github project</a></footer>
</body>
</html>